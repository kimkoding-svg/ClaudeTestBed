/**
 * PDF Generator Service
 *
 * Generates tax summary PDF documents using pdf-lib.
 * Zero native dependencies - pure JavaScript.
 */
const { PDFDocument, rgb, StandardFonts } = require('pdf-lib');
const crypto = require('crypto');
const log = require('../logger').child('PDF-GEN');

// In-memory PDF storage with TTL
const pdfStore = new Map();

const COLORS = {
  orange: rgb(0.95, 0.45, 0.1),    // Sakura accent
  darkGray: rgb(0.2, 0.2, 0.2),
  mediumGray: rgb(0.4, 0.4, 0.4),
  lightGray: rgb(0.85, 0.85, 0.85),
  white: rgb(1, 1, 1),
  black: rgb(0, 0, 0),
  red: rgb(0.8, 0.15, 0.15),
  green: rgb(0.1, 0.6, 0.2),
};

/**
 * Generate a tax summary PDF
 * @returns {string} PDF ID for retrieval
 */
async function generateTaxSummary(data) {
  const pdfDoc = await PDFDocument.create();
  const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
  const fontBold = await pdfDoc.embedFont(StandardFonts.HelveticaBold);

  const page = pdfDoc.addPage([595, 842]); // A4
  const { width, height } = page.getSize();
  let y = height - 50;

  // === Header ===
  // Orange accent bar
  page.drawRectangle({
    x: 0, y: height - 80,
    width: width, height: 80,
    color: COLORS.orange,
  });

  page.drawText('TAX SUMMARY', {
    x: 50, y: height - 45,
    size: 24,
    font: fontBold,
    color: COLORS.white,
  });

  page.drawText(`Generated by Sakura AI Tax Assistant`, {
    x: 50, y: height - 65,
    size: 10,
    font: font,
    color: rgb(1, 1, 1, 0.8),
  });

  const taxYear = data.tax_year || '2024-2025';
  page.drawText(`Tax Year: ${taxYear}`, {
    x: width - 180, y: height - 45,
    size: 12,
    font: fontBold,
    color: COLORS.white,
  });

  y = height - 110;

  // === Taxpayer Details ===
  y = drawSectionHeader(page, 'TAXPAYER DETAILS', y, fontBold, width);

  y = drawLabelValue(page, 'Name:', data.taxpayer_name || 'Not provided', y, font, fontBold);
  if (data.age) {
    y = drawLabelValue(page, 'Age:', String(data.age), y, font, fontBold);
  }
  y -= 10;

  // === Income Summary ===
  y = drawSectionHeader(page, 'INCOME SUMMARY', y, fontBold, width);

  y = drawLabelValue(page, 'Gross Income:', formatRand(data.gross_income), y, font, fontBold);

  if (data.deductions && Object.keys(data.deductions).length > 0) {
    y -= 5;
    page.drawText('Deductions:', {
      x: 50, y,
      size: 10,
      font: fontBold,
      color: COLORS.darkGray,
    });
    y -= 15;

    for (const [key, value] of Object.entries(data.deductions)) {
      const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
      y = drawLabelValue(page, `  ${label}:`, formatRand(value), y, font, font, 70);
      if (y < 80) {
        // Add new page if needed
        break;
      }
    }
  }

  y = drawLabelValue(page, 'Taxable Income:', formatRand(data.taxable_income || data.gross_income), y, font, fontBold);
  y -= 10;

  // === Tax Calculation ===
  y = drawSectionHeader(page, 'TAX CALCULATION', y, fontBold, width);

  if (data.calculation_details && data.calculation_details.summary) {
    const summary = data.calculation_details.summary;
    y = drawLabelValue(page, 'Gross Tax:', formatRand(summary.grossTax), y, font, fontBold);
    y = drawLabelValue(page, 'Total Rebates:', `- ${formatRand(summary.totalRebates)}`, y, font, fontBold);
    y = drawLabelValue(page, 'Tax After Rebates:', formatRand(summary.taxAfterRebates), y, font, fontBold);

    if (summary.medicalCredits > 0) {
      y = drawLabelValue(page, 'Medical Credits:', `- ${formatRand(summary.medicalCredits)}`, y, font, fontBold);
    }
  }

  y -= 5;

  // Final tax payable - highlighted
  page.drawRectangle({
    x: 40, y: y - 5,
    width: width - 80, height: 25,
    color: COLORS.orange,
  });

  page.drawText('FINAL TAX PAYABLE:', {
    x: 50, y: y,
    size: 12,
    font: fontBold,
    color: COLORS.white,
  });

  page.drawText(formatRand(data.tax_payable), {
    x: 350, y: y,
    size: 14,
    font: fontBold,
    color: COLORS.white,
  });

  y -= 35;

  // Monthly equivalent
  if (data.calculation_details && data.calculation_details.summary) {
    const monthly = data.calculation_details.summary.monthlyTax;
    y = drawLabelValue(page, 'Monthly Tax:', formatRand(monthly), y, font, fontBold);
    y = drawLabelValue(page, 'Effective Rate:', `${data.calculation_details.summary.effectiveRate}%`, y, font, fontBold);
  }

  y -= 20;

  // === Tax Bracket Breakdown ===
  if (data.calculation_details && data.calculation_details.details && data.calculation_details.details.tax) {
    const taxDetails = data.calculation_details.details.tax;
    if (taxDetails.brackets && taxDetails.brackets.length > 0 && y > 200) {
      y = drawSectionHeader(page, 'BRACKET BREAKDOWN', y, fontBold, width);

      // Table header
      page.drawRectangle({
        x: 40, y: y - 2,
        width: width - 80, height: 18,
        color: COLORS.lightGray,
      });

      page.drawText('Bracket', { x: 50, y: y + 2, size: 9, font: fontBold, color: COLORS.darkGray });
      page.drawText('Rate', { x: 280, y: y + 2, size: 9, font: fontBold, color: COLORS.darkGray });
      page.drawText('Tax', { x: 380, y: y + 2, size: 9, font: fontBold, color: COLORS.darkGray });
      y -= 20;

      for (const bracket of taxDetails.brackets) {
        page.drawText(bracket.range, { x: 50, y, size: 8, font: font, color: COLORS.mediumGray });
        page.drawText(bracket.rate, { x: 280, y, size: 8, font: font, color: COLORS.mediumGray });
        page.drawText(formatRand(bracket.tax), { x: 380, y, size: 8, font: font, color: COLORS.mediumGray });
        y -= 15;
        if (y < 120) break;
      }
    }
  }

  // === Credits section ===
  if (data.credits && Object.keys(data.credits).length > 0 && y > 150) {
    y -= 10;
    y = drawSectionHeader(page, 'CREDITS & REBATES', y, fontBold, width);
    for (const [key, value] of Object.entries(data.credits)) {
      const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
      y = drawLabelValue(page, `${label}:`, formatRand(value), y, font, font);
      if (y < 80) break;
    }
  }

  // === Footer ===
  // Disclaimer
  page.drawRectangle({
    x: 0, y: 0,
    width: width, height: 60,
    color: COLORS.lightGray,
  });

  page.drawText('DISCLAIMER', {
    x: 50, y: 42,
    size: 8,
    font: fontBold,
    color: COLORS.red,
  });

  page.drawText('This is NOT an official SARS document. It is a summary generated by an AI assistant for informational', {
    x: 50, y: 30,
    size: 7,
    font: font,
    color: COLORS.mediumGray,
  });

  page.drawText('purposes only. Please consult a registered tax practitioner for professional tax advice.', {
    x: 50, y: 20,
    size: 7,
    font: font,
    color: COLORS.mediumGray,
  });

  page.drawText(`Generated: ${new Date().toLocaleDateString('en-ZA')}`, {
    x: width - 150, y: 10,
    size: 7,
    font: font,
    color: COLORS.mediumGray,
  });

  // Save PDF
  const pdfBytes = await pdfDoc.save();
  const pdfId = crypto.randomBytes(8).toString('hex');

  pdfStore.set(pdfId, {
    bytes: Buffer.from(pdfBytes),
    filename: `tax-summary-${data.taxpayer_name ? data.taxpayer_name.replace(/\s+/g, '-').toLowerCase() : 'unknown'}-${taxYear}.pdf`,
    createdAt: Date.now(),
  });

  // Auto-expire after 30 minutes
  setTimeout(() => {
    pdfStore.delete(pdfId);
  }, 30 * 60 * 1000);

  log.info('PDF generated', { pdfId, size: pdfBytes.length, taxpayer: data.taxpayer_name });
  return pdfId;
}

/**
 * Get a stored PDF by ID
 */
function getPDF(pdfId) {
  return pdfStore.get(pdfId) || null;
}

// === Helper drawing functions ===

function drawSectionHeader(page, text, y, fontBold, pageWidth) {
  page.drawRectangle({
    x: 40, y: y - 3,
    width: pageWidth - 80, height: 1,
    color: COLORS.orange,
  });

  page.drawText(text, {
    x: 50, y: y + 2,
    size: 11,
    font: fontBold,
    color: COLORS.orange,
  });

  return y - 20;
}

function drawLabelValue(page, label, value, y, font, valueFont, labelX = 50) {
  page.drawText(label, {
    x: labelX, y,
    size: 10,
    font: font,
    color: COLORS.mediumGray,
  });

  page.drawText(String(value), {
    x: 350, y,
    size: 10,
    font: valueFont,
    color: COLORS.darkGray,
  });

  return y - 16;
}

function formatRand(amount) {
  if (amount === undefined || amount === null) return 'R0.00';
  return `R${Number(amount).toLocaleString('en-ZA', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
}

module.exports = {
  generateTaxSummary,
  getPDF,
};
